<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Spark working internals, and why should you care?</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Slick Carousel -->
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/slick/slick.css" />
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/slick/slick-theme.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/font-awesome/css/font-awesome.min.css" />

  <!-- Magnific Popup -->
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/magnafic-popup/magnific-popup.css" />

  <!-- Stylesheets -->
  
  <link href="https://anhcodes.dev/scss/style.min.css" rel="stylesheet" />

  <!--Favicon-->
  <link rel="shortcut icon" href="https://anhcodes.dev/images/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="https://anhcodes.dev/images/favicon.png" type="image/x-icon" />
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G09NWG7ZSN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-G09NWG7ZSN');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.37.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch.umd.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">  
  
</head>

<body>
  <nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a href="https://anhcodes.dev/" class="navbar-brand">
      <img src="https://anhcodes.dev/images/favicon.png" alt="site-logo">
    </a>
    <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
      <span class="navbar-toggler-icon"></span>
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
      <ul class="nav navbar-nav main-navigation my-0 mx-auto">
        
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#home"
            class="nav-link text-dark text-sm-center p-2 ">Home</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#about"
            class="nav-link text-dark text-sm-center p-2 ">About</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#resume"
            class="nav-link text-dark text-sm-center p-2 ">Experiences</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#skills"
            class="nav-link text-dark text-sm-center p-2 ">Skills</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#testimonial"
            class="nav-link text-dark text-sm-center p-2 ">Testimonials</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#blog"
            class="nav-link text-dark text-sm-center p-2 ">Blog</a>
        </li>
        
      </ul>
      <div class="navbar-nav">
        <a href="https://anhcodes.dev/contact" class="btn btn-primary btn-zoom hire_button">Contact Me</a>
      </div>
    </div>
  </div>
</nav>
  <div id="content">
    

<header class="breadCrumb">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-12 offset-lg-1 offset-md-0 text-center">
        <h3 class="breadCrumb__title">Spark working internals, and why should you care?</h3>
        <nav aria-label="breadcrumb" class="d-flex justify-content-center">
          <ol class="breadcrumb align-items-center">
            <li class="breadcrumb-item"><a href=https://anhcodes.dev/>Home</a></li>
            <li class="breadcrumb-item"><a href=https://anhcodes.dev/blog>All Posts</a></li>
            <li class="breadcrumb-item"><a href=https://anhcodes.dev//tags>All Tags</a></li>
          </ol>
        </nav>
      </div>
    </div>

    <ul class="post-meta">
      <li>
        <i class="fa fa-calendar"></i>
        May 27, 2023
      </li>
      <li>
        <i class="fa fa-clock-o"></i>
        9 mins read
      </li>
      <li>
        <i class="fa fa-user"></i>
        Anh Chu
      </li>
    </ul>
    <ul class="post-meta">
      </li>
      
      <li>
        <i class="fa fa-tag"></i>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/spark/">spark</a>
        
      </li>
      
    </ul>
  </div>
  </div>
  </div>
  </div>
</header>

<section class="section singleBlog">
  <div class="svg-img">
    <img src=https://anhcodes.dev/images/hero/hero-background-svg.svg alt="">
  </div>
  <div class="animate-shape">
    <img src=https://anhcodes.dev/images/skill/skill-background-shape.svg alt="">
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="singleBlog__feature">
          <img src=https://anhcodes.dev/images/single-blog/tune-spark/wormhole.gif alt="feature-image">
          <center><figcaption style="font-size: 10px; margin-top: 20px;">  </figcaption></center>
        </div>
      </div>
    </div>
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="singleBlog__content">

          
            <h3>Table of Contents</h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#spark-architecture">Spark Architecture</a>
      <ul>
        <li><a href="#spark-cluster-components">Spark Cluster Components</a></li>
        <li><a href="#spark-session">Spark Session</a></li>
        <li><a href="#spark-apis">Spark APIs</a></li>
      </ul>
    </li>
    <li><a href="#computation-in-spark">Computation in Spark</a>
      <ul>
        <li><a href="#spark-catalyst-optimizer">Spark Catalyst Optimizer</a></li>
        <li><a href="#adaptive-query-execution">Adaptive Query Execution</a></li>
      </ul>
    </li>
    <li><a href="#shuffle-partitioning-and-caching-in-spark">Shuffle, Partitioning and Caching in Spark</a>
      <ul>
        <li><a href="#partitioning">Partitioning</a></li>
        <li><a href="#shuffle">Shuffle</a></li>
        <li><a href="#cache-in-spark">Cache in Spark</a></li>
      </ul>
</nav>
          

          <p>Most Big Data developers and Data Engineers start learning Spark by writing SparkSQL codes to perform ETL on DataFrame (I know I did). I also wrote a post about <a href="https://anhcodes.dev/blog/tune-spark-sql-programming/">SparkSQL Programming</a>. However, we quickly learn that there’s more knowlege required to go from processing a few GBs of data to dealing with TBs and PBs of data, which is a challenge for big enterprises. Learning to write correct Spark codes is only a small part of the battle, you will need to understand the Spark Architecture and Spark working internals to correct tune Spark to handle true big data, and it’s the focus of this post.</p>
<h2 id="spark-architecture">Spark Architecture</h2>
<p>First, let this sink in: Spark is an <strong>in-memory</strong>, <strong>parallel processing engine</strong> that is very <strong>scalable.</strong>  The more data you have, the more powerful Spark can become that sets it apart from other processing engines. Spark is faster than Map Reduce paradigm because it processes data in memory, which means that it can reduce the disk IO that normally slows down Map Reduce jobs. Spark is fast because of the ability to process data in parallel.</p>
<p>Parallelism is key enabler of Spark efficiency. The Spark Architecture is designed so that you can add new computers to process growing amount of big data in parallel.</p>
<h3 id="spark-cluster-components">Spark Cluster Components</h3>
<p>A Spark cluster has, a driver and mutiple workers (think computers).</p>
<ul>
<li>Spark driver (JVMs) is responsible for instantiate Spark Session, turn Spark operations into DAGs, schedule and distribute tasks to the workers.</li>
<li>Each worker has multiple cores (think threads) that can run multiple tasks. Each task is a single unit of work, each task maps to a single core and works on a single partition of data at a given time (1 task, 1 partition, 1 slot, 1 core)</li>
<li>Besides, we also have a <strong>cluster manager,</strong> and <strong>Spark Session</strong> that runs Spark applications.</li>
</ul>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/1.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<h3 id="spark-session">Spark Session</h3>
<p>SparkSession is the single point of entry to all DataFrame API functionality. SparkSession is available since Spark 2.0, before that Spark Context was used with a limitation of only one Spark Context per JVM. SparkSession can unify numerous Spark Contexts.</p>
<p>SparkSession automatically created in a Databricks notebook as the variable <code>spark</code>.</p>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/2.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#b0bec5"># In below code, the `spark` variable specifies a sparkSession</span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># spark.table reads a table to a dataframe</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ffb8d1">=</span> spark<span style="color:#ffb8d1">.</span>table(<span style="color:#1bc5e0">&#39;&lt;table&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ffb8d1">.</span>select(<span style="color:#1bc5e0">&#39;a&#39;</span>, <span style="color:#1bc5e0">&#39;b&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ffb8d1">.</span>where(<span style="color:#1bc5e0">&#39;a&gt;1&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ffb8d1">.</span>orderBy(<span style="color:#1bc5e0">&#39;b&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># spark.read reads files to a dataframe</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ffb8d1">=</span> spark<span style="color:#ffb8d1">.</span>read<span style="color:#ffb8d1">.</span>parquet(<span style="color:#1bc5e0">&#39;path/to/parquet&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># spark.sql execute sql queries on a table and save the result set to df</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ffb8d1">=</span> spark<span style="color:#ffb8d1">.</span>sql(<span style="color:#1bc5e0">&#39;select * from &lt;table&gt;&#39;</span>)
</span></span></code></pre></div><h3 id="spark-apis">Spark APIs</h3>
<p>Spark ecosystems have 4 APIs: SparkSQL, Spark Structured Streaming,  SparkML, and GraphX (I haven’t  used this before, not sure if it’s deprecated or not). Most of Spark developers started with SparkSQL APIs with ingestion and transformations on Spark DataFrame. However, Spark Structured Streaming and SparkML are pretty popular too, which we can discuss later in later posts.</p>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/1.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<h2 id="computation-in-spark">Computation in Spark</h2>
<p>Earlier I mentioned that Driver is responsible to turn operations into jobs or DAGs. DAGs are Directed Acyclic Graphs (fancy word for graphs that have direction with no cycle). In a spark execution plan, each <strong>job</strong> is a DAG, each node within a DAG can have one or multiple <strong>stages</strong>, each stage can have multiple <strong>tasks</strong> (clear?)</p>
<p>Spark parallelizes at 2 levels:</p>
<ul>
<li>splitting work among workers, executors (or workers) will run the spark code on the data partitions it has</li>
<li>each executors have a number of slots/cores, each slot can execute a task on a data partition.</li>
</ul>
<p>Another characteristic of Spark is lazy execution. When you specify transformations on a Spark DataFrame, Spark records lineage and only start the computation when an action is triggered (refer to my previous post about <a href="https://anhcodes.dev/blog/tune-spark-sql-programming/">SparkSQL programming</a> for more information on transformations and actions)</p>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/3.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<p>Under the hood, SparkSQL uses Spark Catalyst Optimizer to optimize query performation, similar to how a relational database or a data warehouse plans their query jobs.</p>
<h3 id="spark-catalyst-optimizer">Spark Catalyst Optimizer</h3>
<p>The Catalyst Optimizer is a component of Spark SQL that performs optimization on a query through 4 stages:</p>
<ul>
<li>analysis: create abstract syntax tree of a query</li>
<li>logical optimization: create plan and cost-based optimizer and assign costs to plan</li>
<li>physical planning: generate physical plan based on logical plan</li>
<li>code generation: generate java <strong>bytecode</strong> to run on each machine, spark sql acts as a <strong>compiler</strong>. Project Tungsten engine generate RDD code</li>
</ul>
<p>Catalyst Optimizer is a rule based engine that takes the Logical Plan and rewrites it as an optimized Physical Plan. The Physical Plan is developed BEFORE a query is executed</p>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/4.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<p>To view the Catalyst Optimizier in action, use <code>df.explain(True)</code> to view the Logical and Physical Execution plans of a query.</p>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/5.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<h3 id="adaptive-query-execution">Adaptive Query Execution</h3>
<p>In Spark 3.0, Adaptive Query Execution (AQE) was introduced. One difference between AQE and Catalyst Optimizer is that AQE modifies the Physical Plan based on Runtime Statistics, so AQE can tune your queries further on the flight. So you may think that AQE is complimentary to Catalyst Optimizer.</p>
<p>For example, during runtime, based on the new information that is previously not available during planning, AQE can decide to change your join strategy to Broadcast Hash Join from Sort Merge Join to reduce data shuffle. Or AQE can coalesce your partitions to optimal size during shuffling stage, or help improve Skew Join.</p>
<p>This option is not turned on by default in Spark, you can enable by setting spark config: <code>spark.conf.set(spark.sql.adaptive.enabled, True)</code> , and it’s recommended to turn this on. However, If you run Spark on later version of Databricks Runtime, AQE is enabled by default.</p>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/6.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<h2 id="shuffle-partitioning-and-caching-in-spark">Shuffle, Partitioning and Caching in Spark</h2>
<p>We established that Spark processes data in parallel by splitting up data into <strong>partitions</strong> and <strong>move (shuffle)</strong> them to each executors so that they can run a task on a small subset of data in <strong>memory.</strong></p>
<p><strong>Shufflings, partitionings,</strong> and <strong>memory can</strong> potentially dictate Spark performance. So if you understand these terms in depth, debugging Spark can become much easier, which I explained further in another post about <a href="https://anhcodes.dev/blog/debug-spark/">Debugging Long Running Spark Job</a></p>
<p>To process your data, Spark will first have to ingest files from disk to memory, and by default it reads data into partitions of 128MB. If there’s any wide transformation on the DataFrame, Spark needs to repartition the data and move partititions to cores for processing. The implication of this is each partition will have to fit into the core’s memory or you will have spill or OOM errors. If partitions are not evenly distributed, you can have skew (which means some executors have more works than the others). Correctly tuning partitions upon ingestion and upon shuffling stage can help improve your Spark jobs.</p>
<h3 id="partitioning">Partitioning</h3>
<p>There are 2 types of partitioning:</p>
<ul>
<li>Spark Partition: partition in flight (in RAM)</li>
<li>Disk Partition (Hive partition): partition at rest (on disk)</li>
</ul>
<p>When Spark read data from disk to memory (dataframe), the initial partition in the dataframe (in MEMORY) will be determined by number of cores (default level of parallelism), dataset size, <code>spark.sql.files.maxPartitionBytes</code> config, <code>spark.sql.files.openCostInBytes</code> (default 4MB, overhead of opening file). Remember that this is the size of the partition in Memory, irrelevant to what it is on disk.</p>
<p>Check number of partitions in DataFrame when ingested from disk to memory with <code>df.rdd.getNumPartitions()</code>. We can estimate the size of your dataframe in memory by multiply the number of partitions in memory by the partition size.</p>
<ul>
<li>By default, each partition has the size of 128MB but you can set with <code>spark.sql.files.maxPartitionBytes</code>. A situation when setting this config can be beneficial is to write data to 1GB part files.</li>
</ul>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/7.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<ul>
<li>Don’t allow partition size to increase &gt;200MB per 8GB of core total memory, if more than that, increase number of partitions. It’s better to have many small partitions than too few large partitions.</li>
<li>It’s best to tune the number of partitions so it is at least a multiple of number of cores in your cluster. This allows for better paralellism. Run <code>df.rdd.getNumPartitions()</code> to check the number of partitions in memory.</li>
<li>In case if you want to change partition size at runtime, you can run <code>coalesce()</code> and <code>repartition()</code>.  Coalesce can only reduce the number of partitions and increase partition size, but as a <strong>narrow transformation</strong> with no shuffling, coalsce is more efficient than repartition. Repartition returns new DF with exactly N partitions of even size. It can increase or decrease your partition count, but it requires expensive data shuffling</li>
</ul>
<h3 id="shuffle">Shuffle</h3>
<p>Shuffle is one of the most expensive operation in Spark. In every wide transformation (for example a <code>groupBy</code>), shuffle create multiple stages:</p>
<ul>
<li>First stage will create shuffle files (shuffle write)</li>
<li>Subsequent stages will reuse those shuffle files (shuffle read)</li>
</ul>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/8.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<ul>
<li>If cache is used, first stage can create shuffle files and cache the results, later stages can read from cache with improve the performance</li>
</ul>

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/9.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  

<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/single-blog/tune-spark/10.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<p>The issues with shuffle partitions are:</p>
<ul>
<li>Too many partitions and you may have empty or very small partitions which put pressure on driver. This issue can be solved by enabling Adaptive Query Execution (AQE) as explained above</li>
<li>Too few partitions and big partitions can cause spill or OOM. Correctly setting the <code>spark.sql.shuffle.partitions</code> based on the rule in partition section can help. This setting indicates how many partitions Spark will create for the next stage, and it MUST be managed by user for every job.</li>
</ul>
<p>Besides, there are a few techniques to mitigate excessive shuffles in my previous post <a href="https://anhcodes.dev/blog/debug-spark/">Debugging Long Running Spark Job</a></p>
<h3 id="cache-in-spark">Cache in Spark</h3>
<p>By default, data in a DataFrame is only present in Spark cluster while bing processed during a query, it won’t be persisted on a cluster afterwards. However, you can explicitly request Spark to persist DataFrame on the cluster by invoking <code>df.cache</code>. Cache can store as many partitions of the dataframe as the cluster memory allows</p>
<p>Note that cache is another type of persist: <code>df.cache</code> is <code>df.persist(StorageLevel.MEMORY_AND_DISK)</code>. This stores partitions in memory and spills excess to disk.</p>
<p>Cache should be used with care because caching consumes cluster resources that could otherwise be used for other executions, and it can prevent Spark from performing query optimization. You should only used cache in below situations:</p>
<ul>
<li>DataFrames frequently used during Exploratory Data Analysis, iterative machine learning training in a Spark session</li>
<li>DataFrames accessed commonly for doing frequent transformations during ETL or building data pipelines</li>
<li>Don’t use when data is too big to fit in memory, or only need infrequent transformation</li>
</ul>
<p>When you use cache() or persist(), the DataFrame is not fully cached until you invoke an action that goes through every record (e.g., count()). If you use an action like take(1)w, only one partition will be cached because Catalyst realizes that you do not need to compute all the partitions just to retrieve one record.</p>
<p>Don’t forget to cleanup with <code>df.unpersist</code> to evict the dataframe from cache when you no longer need it.</p>

        </div>
      </div>
    </div>
  </div>
</section>


  </div>
  <section class="footer" id="contact">
	<div class="footer__background_shape">
		<svg viewBox="0 0 1920 79">
			<path d="M0 0h1920v79L0 0z" data-name="Path 1450" />
		</svg>
	</div>
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div class="footer__cta">
					<div class="shape-1">
						<svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029">
							<path data-name="Path 1449"
								d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z"
								transform="translate(217.489 188.626)" />
						</svg>
					</div>
					<div class="shape-2">
						<svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029">
							<path data-name="Path 1449"
								d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z"
								transform="translate(217.489 188.626)" />
						</svg>
					</div>
					<div class="text-light footer__cta_content">
						<span>Contact me</span>
						<h2 class="mb-0">Let’s Work Together</h2>
					</div>
					<div class="footer__cta_action">
						<a class="btn btn-light btn-zoom" href="https://anhcodes.dev/contact">Get in
							touch</a>
					</div>
				</div>
			</div>
		</div>
		
			
			
		<div class="row footer__footer">
			<div class="col-lg-6">
				<div class="footer__footer_copy text-light">
					<p>©2023 - Made with ☕, Hugo, and Firebase by <a class="text-light" href="https://anhcodes.dev/" target="_blank">Anh Chu</a></p>
				</div>
			</div>
			<div class="col-lg-6">
				<div class="footer__footer_social">
					<ul class="unstyle-list">
						
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://dev.to/anhcodes"><i
									class="fa fa-code"></i></a>
						</li>
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://www.linkedin.com/in/anhhchu/"><i
									class="fa fa-linkedin-square"></i></a>
						</li>
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://github.com/anhhchu"><i
									class="fa fa-github-square"></i></a>
						</li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>
</section>

<script src="https://anhcodes.dev/plugins/jQuery/jquery.min.js"></script>
<script src="https://anhcodes.dev/plugins/bootstrap/bootstrap.min.js"></script>
<script src="https://anhcodes.dev/plugins/slick/slick.min.js"></script>
<script src="https://anhcodes.dev/plugins/waypoint/jquery.waypoints.min.js"></script>
<script src="https://anhcodes.dev/plugins/magnafic-popup/jquery.magnific-popup.min.js"></script>
<script src="https://anhcodes.dev/plugins/tweenmax/TweenMax.min.js"></script>
<script src="https://anhcodes.dev/plugins/imagesloaded/imagesloaded.min.js"></script>
<script src="https://anhcodes.dev/plugins/masonry/masonry.min.js"></script>


<script src="https://anhcodes.dev/js/script.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.37.1"></script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch.umd.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">  

</body>

</html>