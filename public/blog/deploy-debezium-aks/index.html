<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Deploy Debezium and Kafka on AKS using Strimzi Operator</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Slick Carousel -->
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/slick/slick.css" />
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/slick/slick-theme.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/font-awesome/css/font-awesome.min.css" />

  <!-- Magnific Popup -->
  <link rel="stylesheet" href="https://anhcodes.dev/plugins/magnafic-popup/magnific-popup.css" />

  <!-- Stylesheets -->
  
  <link href="https://anhcodes.dev/scss/style.min.css" rel="stylesheet" />

  <!--Favicon-->
  <link rel="shortcut icon" href="https://anhcodes.dev/images/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="https://anhcodes.dev/images/favicon.png" type="image/x-icon" />
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G09NWG7ZSN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-G09NWG7ZSN');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.37.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch.umd.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">  
  
</head>

<body>
  <nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a href="https://anhcodes.dev/" class="navbar-brand">
      <img src="https://anhcodes.dev/images/favicon.png" alt="site-logo">
    </a>
    <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
      <span class="navbar-toggler-icon"></span>
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
      <ul class="nav navbar-nav main-navigation my-0 mx-auto">
        
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#home"
            class="nav-link text-dark text-sm-center p-2 ">Home</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#about"
            class="nav-link text-dark text-sm-center p-2 ">About</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#portfolio"
            class="nav-link text-dark text-sm-center p-2 ">Portfolio</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#resume"
            class="nav-link text-dark text-sm-center p-2 ">Experiences</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#skills"
            class="nav-link text-dark text-sm-center p-2 ">Skills</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#testimonial"
            class="nav-link text-dark text-sm-center p-2 ">Testimonials</a>
        </li>
        
        <li class="nav-item">
          <a href="https://anhcodes.dev/#blog"
            class="nav-link text-dark text-sm-center p-2 ">Blog</a>
        </li>
        
      </ul>
      <div class="navbar-nav">
        <a href="https://anhcodes.dev/contact" class="btn btn-primary btn-zoom hire_button">Contact Me</a>
      </div>
    </div>
  </div>
</nav>
  <div id="content">
    

<header class="breadCrumb">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-12 offset-lg-1 offset-md-0 text-center">
        <h3 class="breadCrumb__title">Deploy Debezium and Kafka on AKS using Strimzi Operator</h3>
        <nav aria-label="breadcrumb" class="d-flex justify-content-center">
          <ol class="breadcrumb align-items-center">
            <li class="breadcrumb-item"><a href=https://anhcodes.dev/>Home</a></li>
            <li class="breadcrumb-item"><a href=https://anhcodes.dev/blog>All Posts</a></li>
            <li class="breadcrumb-item"><a href=https://anhcodes.dev//tags>All Tags</a></li>
          </ol>
        </nav>
      </div>
    </div>

    <ul class="post-meta">
      <li>
        <i class="fa fa-calendar"></i>
        January 7, 2023
      </li>
      <li>
        <i class="fa fa-clock-o"></i>
        11 mins read
      </li>
      <li>
        <i class="fa fa-user"></i>
        Anh Chu
      </li>
    </ul>
    <ul class="post-meta">
      </li>
      
      <li>
        <i class="fa fa-tag"></i>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/kafka/">kafka</a>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/kubernetes/">kubernetes</a>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/debezium/">debezium</a>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/strimzi/">strimzi</a>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/change-data-capture/">change-data-capture</a>
        
          <a class="text-lowercase" href="https://anhcodes.dev/tags/docker/">docker</a>
        
      </li>
      
    </ul>
  </div>
  </div>
  </div>
  </div>
</header>

<section class="section singleBlog">
  <div class="svg-img">
    <img src=https://anhcodes.dev/images/hero/hero-background-svg.svg alt="">
  </div>
  <div class="animate-shape">
    <img src=https://anhcodes.dev/images/skill/skill-background-shape.svg alt="">
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="singleBlog__feature">
          <img src=https://anhcodes.dev/images/single-blog/aksdbz.png alt="feature-image">
          <center><figcaption style="font-size: 10px; margin-top: 20px;">  </figcaption></center>
        </div>
      </div>
    </div>
    <div class="row mt-5">
      <div class="col-lg-12">
        <div class="singleBlog__content">

          

          <p>This tutorial follows Debezium official documentation <a href="https://debezium.io/documentation/reference/stable/operations/kubernetes.html">Deploying Debezium on Kubernetes</a>, but modified for Azure Kubernetes Service and Azure Container Registry.</p>
<h2 id="table-of-content">Table of Content</h2>
<div class="toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-content">Table of Content</a></li>
    <li><a href="#1-prerequisites">1. Prerequisites</a>
      <ul>
        <li><a href="#azure-cli">Azure CLI</a></li>
        <li><a href="#azure-kubernetes-cluster">Azure Kubernetes Cluster</a></li>
        <li><a href="#set-up-kubectl-in-local">Set up kubectl in local</a></li>
        <li><a href="#interact-with-your-aks-cluster-in-your-terminal">Interact with your AKS cluster in your terminal</a></li>
      </ul>
    </li>
    <li><a href="#2-deploy-strimzi-operator">2. Deploy strimzi operator</a></li>
    <li><a href="#3-create-secrets-and-roles">3. Create secrets and roles</a></li>
    <li><a href="#4-deploy-kafka-cluster">4. Deploy kafka cluster</a></li>
    <li><a href="#5-deploy-the-database-mysql">5. Deploy the database (mysql)</a></li>
    <li><a href="#6-deploy-kafka-connect-cluster">6. Deploy Kafka Connect Cluster</a>
      <ul>
        <li><a href="#step-1-create-a-secret-for-your-container-registry-in-the-same-k8s-namespace">Step 1: Create a secret for your container registry in the same k8s namespace</a></li>
        <li><a href="#step-2-modify-the-kafkaconnect-manifest-yaml-to-build-and-push-image-to-container-registry">Step 2: Modify the KafkaConnect Manifest yaml to build and push image to Container Registry.</a></li>
        <li><a href="#step-3-deploy-kafka-connect-resource">Step 3: Deploy kafka-connect resource</a></li>
        <li><a href="#step-4-validate-the-kafka-connect-cluster">Step 4: Validate the kafka connect cluster</a></li>
      </ul>
    </li>
    <li><a href="#7-deploy-debezium-connector">7. Deploy Debezium Connector</a></li>
    <li><a href="#8-verify-deployment">8. Verify deployment</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
</div>
  
<h2 id="1-prerequisites">1. Prerequisites</h2>
<p>You need an Azure account, Azure subscription, and Azure resource group before getting started. You also need to have some understanding of CLI, Docker, Kafka, Debezium, and Kubernetes</p>
<h3 id="azure-cli">Azure CLI</h3>
<p>If you haven&rsquo;t set up your Azure CLI environment, follow this <a href="https://learn.microsoft.com/en-us/cli/azure/manage-azure-subscriptions-azure-cli">documentation</a> to set it up. Remember to set the subscription and resource group that you will use to create AKS cluster as default</p>
<h3 id="azure-kubernetes-cluster">Azure Kubernetes Cluster</h3>
<p>Follow this document to get your Kubernetes cluster ready on AKS: <a href="https://learn.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-portal?tabs=azure-cli#create-an-aks-cluster">Create an AKS Cluster</a></p>
<p>After your aks cluster is created, you should see it on Azure Portal as below. For demo purpose, I created an AKS cluster called <code>anhaks</code> in <code>anhtest</code> resource group</p>


<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/inpost/cdc/aks.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<h3 id="set-up-kubectl-in-local">Set up kubectl in local</h3>
<p>You should have <a href="https://kubernetes.io/docs/tasks/tools/">kubectl installed</a> on your local. If you are using .zshrc, you can also set up autocomplete for kubectl as below. In case you are using <code>ohmyzsh</code> like I do, add  <code>kubectl</code> to your plugins array in your ~/.zshrc file <code>plugins=(... kubectl)</code> (Refer <a href="https://github.com/ohmyzsh/ohmyzsh/tree/master/plugins/kubectl">here</a>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  source &lt;<span style="color:#ffb8d1">(</span>kubectl completion zsh<span style="color:#ffb8d1">)</span>  <span style="color:#b0bec5"># set up autocomplete in zsh into the current shell`</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#1bc5e0">&#39;[[ $commands[kubectl] ]] &amp;&amp; source &lt;(kubectl completion zsh)&#39;</span> &gt;&gt; ~/.zshrc
</span></span></code></pre></div><p>After autocomplete is set up successfully, you should be able to use <code>k</code> instead of <code>kubectl</code> for all of your kubectl command</p>
<h3 id="interact-with-your-aks-cluster-in-your-terminal">Interact with your AKS cluster in your terminal</h3>
<p>Run below script to set up your aks cluster in your local</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $az aks get-credentials --resource-group &lt;myResourceGroup&gt; --name &lt;myAKSCluster&gt;
</span></span></code></pre></div><p>If you use Mac, a file <code>~/.kube/config</code> will be created with 3 things related to your cluster: cluster, context, and user. You can view tracked clusters and contexts in this file <code>~/.kube/config</code> or run below commands. You should see your newly-created cluster in this kube/config file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl config view
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl config current-context
</span></span></code></pre></div><p>Next create a namespace <code>debezium-example</code> and set it as default for your context</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#b0bec5"># Create Namespace</span>
</span></span><span style="display:flex;"><span>  $kubectl create ns debezium-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># set default namespace, cluster and user for context</span>
</span></span><span style="display:flex;"><span>  $kubectl config set-context <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>        &lt;CONTEXT_NAME&gt; <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>        --namespace<span style="color:#ffb8d1">=</span>&lt;NAMESPACE_NAME&gt; <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>        --cluster<span style="color:#ffb8d1">=</span>&lt;CLUSTER_NAME&gt; <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>        --user<span style="color:#ffb8d1">=</span>&lt;USER_NAME&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># set Context as default</span>
</span></span><span style="display:flex;"><span>  $kubectl config use-context &lt;Context Name&gt; 
</span></span></code></pre></div><p><strong>Note:</strong> The kube config file is a useful tool that helps you interact with your cluster using CLI. If you delete a cluster, you should unset deleted cluster from kubectl config file to keep this file clean. For example, you can unset cluster/context/user in kube config like as below</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl config unset contexts.anh-test-aks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl config unset users.clusterUser_anh-test_anh-test-aks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl config unset clusters.anh-test-aks  
</span></span></code></pre></div><h2 id="2-deploy-strimzi-operator">2. Deploy strimzi operator</h2>
<p>First deploy <strong>Operator lifecycle manager</strong> as presequisite to deploy strimzi operator. We need OLM because the Operator Lifecycle Manager (OLM) extends Kubernetes to provide a declarative way to install, manage, and upgrade Operators on a cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $curl -sL https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.20.0/install.sh | bash -s v0.20.0
</span></span></code></pre></div><p>2 namespaces got created: olm and operators. <code>operators</code> namespace will be empty until we install strimzi</p>
<p><strong>namespace: olm</strong></p>
<ul>
<li>services: <code>k get service -n olm</code>
<ul>
<li>operatorhubio-catalog</li>
<li>packageserver-service</li>
</ul>
</li>
<li>deployments: <code>k get deployment -n olm</code>
<ul>
<li>catalog-operator</li>
<li>olm-operator</li>
<li>packageserver</li>
</ul>
</li>
<li>pods: <code>k get pod -n olm</code>
<ul>
<li>catalog-operator-6587ff6f69-sv2zf</li>
<li>olm-operator-6ccdf8f464-dnk98</li>
<li>operatorhubio-catalog-kxk5z</li>
<li>packageserver-5b956ccc98-w7j2l</li>
<li>packageserver-5b956ccc98-xsqjt</li>
</ul>
</li>
</ul>
<p>Secondly, deploy <strong>strimzi operator</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -f https://operatorhub.io/install/strimzi-kafka-operator.yaml
</span></span></code></pre></div><p>A deployment and pod will be created for strimzi</p>
<p><strong>namespace: operators</strong></p>
<ul>
<li>services: <code>k get service -n operators</code> -&gt; empty</li>
<li>deployments: <code>k get deployment -n operators</code>
<ul>
<li>strimzi-cluster-operator-v0.32.0</li>
</ul>
</li>
<li>pods: <code>k get pod -n operators</code>
<ul>
<li>strimzi-cluster-operator-v0.32.0-77c6dc8b69-qcbxj</li>
</ul>
</li>
</ul>
<hr>
<p><strong>You can find all kubernetes manifest yml files used in below sections at this <a href="https://github.com/anhhchu/debezium-aks">Github repo</a></strong></p>
<h2 id="3-create-secrets-and-roles">3. Create secrets and roles</h2>
<p>These secrets and roles helps Kafka Connector connects to the database. Create them in debezium-example namespace. Run below scripts at the directory of the yml files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f debezium-secret.yml
</span></span></code></pre></div><ul>
<li>secrets: debezium-secret (<code>kubectl get secrets -n debezium-example</code>)</li>
<li>The username and password contain base64-encoded credentials (debezium/dbz) for connecting to the MySQL database, which we will deploy later.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f debezium-role.yml
</span></span></code></pre></div><ul>
<li>Role <code>connector-configuration-role</code> created (<code>kubectl get roles -n debezium-example</code>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f debezium-role-binding.yml
</span></span></code></pre></div><ul>
<li>Created a role binding <code>connector-configuration-role-binding</code> (<code>kubectl get rolebinding -n debezium-example</code>)</li>
</ul>
<blockquote>
<p><strong>Note:</strong> If you look in 🔗<a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/debezium-role-binding.yml">debezium-role-binding.yml</a>  file, you will see that the subjects.name of the Service Account is <code>debezium-connect-cluster-connect</code>. The service account will be created by Strimzi once we deploy Kafka Connect. The name of the service account take the form <code>$KafkaConnectName-connect</code>.  Later on, we will the create Kafka Connect cluster named <code>debezium-connect-cluster</code> and therefore we used <code>debezium-connect-cluster-connect</code> here as a subjects.name.</p>
</blockquote>
<p>At this point, we only created secrets and roles, the debezium-example namespace doesn&rsquo;t have any service, deployment or pod yet.</p>
<h2 id="4-deploy-kafka-cluster">4. Deploy kafka cluster</h2>
<p>Create <code>debezium-cluster</code> kafka cluster with <a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/kafka.yml">kafka.yml</a>🔗</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f kafka.yml
</span></span><span style="display:flex;"><span>&gt; kafka.kafka.strimzi.io/debezium-cluster created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># Wait until kafka cluster ready </span>
</span></span><span style="display:flex;"><span>  $kubectl wait kafka/debezium-cluster --for<span style="color:#ffb8d1">=</span>condition<span style="color:#ffb8d1">=</span>Ready --timeout<span style="color:#ffb8d1">=</span>300s -n debezium-example
</span></span></code></pre></div><p>Validate kafka cluster has been created</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl get kafka -n debezium-example
</span></span><span style="display:flex;"><span>  NAME               DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS   READY   WARNINGS
</span></span><span style="display:flex;"><span>  debezium-cluster   <span style="color:#c5a3ff">1</span>                        <span style="color:#c5a3ff">1</span>                     True 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get service -n debezium-example
</span></span><span style="display:flex;"><span>  NAME                                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ffb8d1">(</span>S<span style="color:#ffb8d1">)</span>                               AGE
</span></span><span style="display:flex;"><span>  debezium-cluster-kafka-0                    NodePort    10.0.49.104    &lt;none&gt;        9094:31195/TCP                        20h
</span></span><span style="display:flex;"><span>  debezium-cluster-kafka-bootstrap            ClusterIP   10.0.194.235   &lt;none&gt;        9091/TCP,9092/TCP,9093/TCP            20h
</span></span><span style="display:flex;"><span>  debezium-cluster-kafka-brokers              ClusterIP   None           &lt;none&gt;        9090/TCP,9091/TCP,9092/TCP,9093/TCP   20h
</span></span><span style="display:flex;"><span>  debezium-cluster-kafka-external-bootstrap   NodePort    10.0.66.165    &lt;none&gt;        9094:32034/TCP                        20h
</span></span><span style="display:flex;"><span>  debezium-cluster-zookeeper-client           ClusterIP   10.0.104.91    &lt;none&gt;        2181/TCP                              20h
</span></span><span style="display:flex;"><span>  debezium-cluster-zookeeper-nodes            ClusterIP   None           &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP            20h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get deployment
</span></span><span style="display:flex;"><span>  NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>  debezium-cluster-entity-operator   1/1     <span style="color:#c5a3ff">1</span>            <span style="color:#c5a3ff">1</span>           20h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get pod
</span></span><span style="display:flex;"><span>  NAME                                                READY   STATUS      RESTARTS   AGE
</span></span><span style="display:flex;"><span>  debezium-cluster-entity-operator-5cc76b7dfb-njt62   3/3     Running     <span style="color:#c5a3ff">0</span>          20h
</span></span><span style="display:flex;"><span>  debezium-cluster-kafka-0                            1/1     Running     <span style="color:#c5a3ff">0</span>          20h
</span></span><span style="display:flex;"><span>  debezium-cluster-zookeeper-0                        1/1     Running     <span style="color:#c5a3ff">0</span>          20h
</span></span></code></pre></div><h2 id="5-deploy-the-database-mysql">5. Deploy the database (mysql)</h2>
<p>Create mysql service and deployment</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f mysql.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get deployment
</span></span></code></pre></div><h2 id="6-deploy-kafka-connect-cluster">6. Deploy Kafka Connect Cluster</h2>
<h3 id="step-1-create-a-secret-for-your-container-registry-in-the-same-k8s-namespace">Step 1: Create a secret for your container registry in the same k8s namespace</h3>
<p>If you use docker container registry, use your docker username and password to create a k8s secret. For example, I created <code>anhdockercr-secret</code> below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create secret docker-registry anhdockercr-secret --docker-server<span style="color:#ffb8d1">=</span>docker.io --docker-username<span style="color:#ffb8d1">=</span>anhhoangchu --docker-password<span style="color:#ffb8d1">=</span>&lt;password&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get secret anhdockercr-secret --output<span style="color:#ffb8d1">=</span>yaml &gt; anhdockercr-secret.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get secret anhdockercr-secret --output<span style="color:#ffb8d1">=</span><span style="color:#1bc5e0">&#34;jsonpath={.data.\.dockerconfigjson}&#34;</span> | base64 --decode
</span></span></code></pre></div><p>If you use Azure Container Registry (ACR): follow this <a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-auth-kubernetes">doc</a>. My ACR is <code>anhcr</code>. Remember to change the role to <code>acrpush</code> from <code>acrpull</code> to get the permission to both push and pull images to your Azure Container Registry. Refer my <a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/az-ad-sp.sh">az-ad-sp.sh</a> for more information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#b0bec5"># Create image pull secret</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl create secret docker-registry &lt;secret-name&gt; <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --namespace &lt;namespace&gt; <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --docker-server<span style="color:#ffb8d1">=</span>&lt;container-registry-name&gt;.azurecr.io <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --docker-username<span style="color:#ffb8d1">=</span>&lt;service-principal-ID&gt; <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --docker-password<span style="color:#ffb8d1">=</span>&lt;service-principal-password&gt;
</span></span></code></pre></div><p>For example, I created <code>anhcr-secret</code> for k8s secret</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create secret docker-registry anhcr-secret <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --namespace debezium-example <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --docker-server<span style="color:#ffb8d1">=</span>anhcr.azurecr.io <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --docker-username<span style="color:#ffb8d1">=</span>92cd834d-74bc-4555-976d-101aef5cf9b0 <span style="color:#1bc5e0">\
</span></span></span><span style="display:flex;"><span><span style="color:#1bc5e0"></span>    --docker-password<span style="color:#ffb8d1">=</span>&lt;sp-password-after-created&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b0bec5"># verify</span>
</span></span><span style="display:flex;"><span>  $kubectl get secret anhcr-secret --output<span style="color:#ffb8d1">=</span>yaml &gt; anhcr-secret.yml    
</span></span></code></pre></div><h3 id="step-2-modify-the-kafkaconnect-manifest-yaml-to-build-and-push-image-to-container-registry">Step 2: Modify the KafkaConnect Manifest yaml to build and push image to Container Registry.</h3>
<p><strong>Option 1: <a href="https://strimzi.io/docs/operators/latest/deploying.html#creating-new-image-using-kafka-connect-build-str">Creating a new container image automatically using Strimzi</a></strong> 🔗</p>
<p>Update the <code>build</code> section in your kafka-connect-build.yml file. Rember to add the secret you created in Step 1 as <code>pushSecret</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#a8757b">  </span><span style="color:#ffb8d1">build</span>:<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">    </span><span style="color:#ffb8d1">output</span>:<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">      </span><span style="color:#ffb8d1">type</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">docker</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">      </span><span style="color:#ffb8d1">image</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">anhcr.azurecr.io/debezium-connect-cluster-image:latest</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">      </span><span style="color:#ffb8d1">pushSecret</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">anhcr-secret</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">    </span><span style="color:#ffb8d1">plugins</span>:<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">      </span>- <span style="color:#ffb8d1">name</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">debezium-mysql-connector</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">        </span><span style="color:#ffb8d1">artifacts</span>:<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">          </span>- <span style="color:#ffb8d1">type</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">tgz</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">            </span><span style="color:#ffb8d1">url</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql/2.1.1.Final/debezium-connector-mysql-2.1.1.Final-plugin.tar.gz</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">            </span><span style="color:#ffb8d1">sha512sum</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">e8f0cdfb2f2c15d8c4685bc4736fd1a94f80bda0327dd02e771a10c8d285b4b8c1e17e7c583b55a174cb375ccd047156e67de44cdb50c7634a5710d7f60f6049</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">      </span>- <span style="color:#ffb8d1">name</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">debezium-postgres-connector</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">        </span><span style="color:#ffb8d1">artifacts</span>:<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">          </span>- <span style="color:#ffb8d1">type</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">zip</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">            </span><span style="color:#ffb8d1">url</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">https://repo1.maven.org/maven2/io/debezium/debezium-connector-postgres/2.1.1.Final/debezium-connector-postgres-2.1.1.Final-plugin.zip</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">            </span><span style="color:#ffb8d1">sha512sum</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">a647a5c4ada510ba521ecdbdc789c01ee73675bb9a97dbf45d0f70251be778360aa52de62b60f8f2791f875d95e7793cad96c5dcddb911c2cea79ea40e85fbe4</span><span style="color:#a8757b">
</span></span></span></code></pre></div><p><strong>Option 2: <a href="https://strimzi.io/docs/operators/latest/deploying.html#creating-new-image-from-base-str">Creating a Docker image from the Kafka Connect base image</a></strong> 🔗</p>
<p>Instead of building the image in the yaml file using Strimzi, you can build your own images based on Kafka Connect image</p>
<p>a) <strong>Download Debezium connector plugins from Maven</strong> to <a href="https://github.com/anhhchu/debezium-aks/tree/main/my-plugins">my-plugins</a> directory on your local</p>
<ul>
<li><a href="https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql">mysql connector</a></li>
<li><a href="https://repo1.maven.org/maven2/io/debezium/debezium-connector-postgres">postgres connector</a></li>
</ul>
<p>b) Build your own image with <code>docker build</code></p>
<ul>
<li>If your machine uses amd64 architecture, you only need to run the regular docker build. If you use Azure Container Registry, refer back to Step 1 to create service principal to login</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $docker login &lt;container-registry&gt; --username &lt;service-principal-name&gt; --password &lt;service-principal-password&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $docker build -t &lt;container-registry&gt;/&lt;image-name&gt;:&lt;tag&gt; .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $docker push &lt;container-registry&gt;/&lt;image-name&gt;:&lt;tag&gt;
</span></span></code></pre></div><p>For example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $docker login anhcr.azurecr.io --username 92cd834d-74bc-4555-976d-101aef5cf9b0 --password &lt;password&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $docker build -t anhcr.azurecr.io/debezium-connect-cluster:latest .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $docker push anhcr.azurecr.io/debezium-connect-cluster:latest
</span></span></code></pre></div><ul>
<li>If your machine uses arm64 architecture (i.e. macbook apple m1, etc), it gets a little more tricky! You will need to use <code>docker buildx build</code> to create a multi-architecture image</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $docker login anhcr.azurecr.io --username 92cd834d-74bc-4555-976d-101aef5cf9b0 --password &lt;password&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $docker buildx build --platform linux/arm64,linux/amd64 -t anhcr.azurecr.io/debezium-connect-cluster:latest . --push
</span></span></code></pre></div><p>After pushing the image to ACR, you should be able to see your image on Azure Portal</p>


<div class="image">
  <style>
    .img-responsive {
      display: block;
      height: auto;
      max-width: 100%;
      cursor: pointer;
    }
  </style>
  <p>
    <center><img src="https://anhcodes.dev/images/inpost/cdc/debezium-connect-cluster.png" alt="blog-img" class="img-responsive" onclick="openModal(this)"></center>
  </p>
</div>

<script>
function openModal(img) {
  var modal = document.createElement('div');
  modal.classList.add('modal');
  modal.innerHTML = '<div class="modal-content"><img src="' + img.src + '"></div>';
  document.body.appendChild(modal);
  modal.addEventListener('click', closeModal);
}

function closeModal(event) {
  if (event.target.classList.contains('modal')) {
    document.body.removeChild(event.target);
  }
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  max-width: 80%;
  max-height: 80%;
  overflow: auto;
}

.modal-content img {
  width: 100%;
  height: auto;
}
</style>

  
<h3 id="step-3-deploy-kafka-connect-resource">Step 3: Deploy kafka-connect resource</h3>
<p>Use <a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/kafka-connect-build.yml">kafka-connect-build.yml</a> file if you choose Option 1 in Step 2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f kafka-connect-build.yml
</span></span></code></pre></div><p><strong>OR</strong> Use <a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/kafka-connect.yml">kafka-connect.yml</a> file if you choose Option 2 in Step 2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -n debezium-example -f kafka-connect.yml
</span></span></code></pre></div><p><strong>Note: If you want to publish your image with a different name, remember to update the above yaml file <code>spec.image</code>:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ffb8d1">spec</span>:<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b"></span>...<span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b">    </span><span style="color:#ffb8d1">image</span>:<span style="color:#a8757b"> </span><span style="color:#ae81ff">&lt;your-container-registry&gt;/&lt;your-image:tag&gt;</span><span style="color:#a8757b">
</span></span></span><span style="display:flex;"><span><span style="color:#a8757b"></span>...<span style="color:#a8757b">
</span></span></span></code></pre></div><h3 id="step-4-validate-the-kafka-connect-cluster">Step 4: Validate the kafka connect cluster</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl get kafkaconnect
</span></span><span style="display:flex;"><span>NAME                       DESIRED REPLICAS   READY
</span></span><span style="display:flex;"><span>debezium-connect-cluster   <span style="color:#c5a3ff">1</span>                  True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get service 
</span></span><span style="display:flex;"><span>NAME                                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ffb8d1">(</span>S<span style="color:#ffb8d1">)</span>                               AGE
</span></span><span style="display:flex;"><span>debezium-cluster-kafka-0                    NodePort    10.0.49.104    &lt;none&gt;        9094:31195/TCP                        9h
</span></span><span style="display:flex;"><span>debezium-cluster-kafka-bootstrap            ClusterIP   10.0.194.235   &lt;none&gt;        9091/TCP,9092/TCP,9093/TCP            9h
</span></span><span style="display:flex;"><span>debezium-cluster-kafka-brokers              ClusterIP   None           &lt;none&gt;        9090/TCP,9091/TCP,9092/TCP,9093/TCP   9h
</span></span><span style="display:flex;"><span>debezium-cluster-kafka-external-bootstrap   NodePort    10.0.66.165    &lt;none&gt;        9094:32034/TCP                        9h
</span></span><span style="display:flex;"><span>debezium-cluster-zookeeper-client           ClusterIP   10.0.104.91    &lt;none&gt;        2181/TCP                              9h
</span></span><span style="display:flex;"><span>debezium-cluster-zookeeper-nodes            ClusterIP   None           &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP            9h
</span></span><span style="display:flex;"><span>debezium-connect-cluster-connect-api        ClusterIP   10.0.203.251   &lt;none&gt;        8083/TCP                              28m
</span></span><span style="display:flex;"><span>mysql                                       ClusterIP   None           &lt;none&gt;        3306/TCP                              9h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get pod
</span></span><span style="display:flex;"><span>NAME                                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>debezium-cluster-entity-operator-5cc76b7dfb-njt62   3/3     Running   <span style="color:#c5a3ff">0</span>          8h
</span></span><span style="display:flex;"><span>debezium-cluster-kafka-0                            1/1     Running   <span style="color:#c5a3ff">0</span>          8h
</span></span><span style="display:flex;"><span>debezium-cluster-zookeeper-0                        1/1     Running   <span style="color:#c5a3ff">0</span>          8h
</span></span><span style="display:flex;"><span>debezium-connect-cluster-connect-8fd6fd988-7fgsg    1/1     Running   <span style="color:#c5a3ff">0</span>          2m57s
</span></span><span style="display:flex;"><span>mysql-6fc7c66c64-qzbdm                              1/1     Running   <span style="color:#c5a3ff">0</span>          8h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get deployment
</span></span><span style="display:flex;"><span>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>debezium-cluster-entity-operator   1/1     <span style="color:#c5a3ff">1</span>            <span style="color:#c5a3ff">1</span>           8h
</span></span><span style="display:flex;"><span>debezium-connect-cluster-connect   1/1     <span style="color:#c5a3ff">1</span>            <span style="color:#c5a3ff">1</span>           3m1s
</span></span><span style="display:flex;"><span>mysql                              1/1     <span style="color:#c5a3ff">1</span>            <span style="color:#c5a3ff">1</span>           8h
</span></span></code></pre></div><p><strong>Troubleshooting:</strong>
If the kafka connect cluster is not ready, and NO service/deployment/pod are created for this resource, we will have to delete the resouces and try again</p>
<p>To delete all resources relating to KafkaConnect (debezium-connect-cluster), you need to delete the kafkaconnect custom resource</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl delete kafkaconnect debezium-connect-cluster
</span></span></code></pre></div><h2 id="7-deploy-debezium-connector">7. Deploy Debezium Connector</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl create -f debezium-connector-mysql.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get kafkaconnector 
</span></span><span style="display:flex;"><span>NAME                       CLUSTER                    CONNECTOR CLASS                              MAX TASKS   READY
</span></span><span style="display:flex;"><span>debezium-connector-mysql   debezium-connect-cluster   io.debezium.connector.mysql.MySqlConnector   <span style="color:#c5a3ff">1</span>           True
</span></span></code></pre></div><h2 id="8-verify-deployment">8. Verify deployment</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl run -n debezium-example -it --rm --image<span style="color:#ffb8d1">=</span>quay.io/debezium/tooling:1.2  --restart<span style="color:#ffb8d1">=</span>Never watcher -- kcat -b debezium-cluster-kafka-bootstrap:9092 -C -o beginning -t mysql.inventory.customers
</span></span></code></pre></div><p>The above actually comprises of 2 commands:</p>
<ul>
<li>
<p><code>kubectl run</code> creates the <code>watcher</code> container in interactive <code>-it</code> mode using image <code>tooling:1.2</code> from quay.io container registry. We need this container up and running so we can execute a shell command <code>kcat</code> on this container. This <code>watcher</code> pod is temporary and will be deleted if you exit the terminal</p>
</li>
<li>
<p>The 🔗<a href="https://codingharbour.com/apache-kafka/learn-how-to-use-kafkacat-the-most-versatile-cli-client/"><code>kcat</code> utility</a> in consumer mode (<code>--C</code>) starts watching topic (<code>--t</code> tag) <code>mysql.inventory.customers</code> (customers table in inventory database from mysql server) from kafka broker (<code>--b</code>) <code>debezium-cluster-kafka-bootstrap</code> at port 9092 starting with offset set to beginning (<code>--o beginning</code>).</p>
</li>
</ul>
<p>Leave the above running, switch to another shell to connect to mysql db</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  $kubectl run -n debezium-example -it --rm --image<span style="color:#ffb8d1">=</span>mysql:8.0 --restart<span style="color:#ffb8d1">=</span>Never --env MYSQL_ROOT_PASSWORD<span style="color:#ffb8d1">=</span>debezium mysqlterm -- mysql -hmysql -P3306 -uroot -pdebezium
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; use inventory
</span></span><span style="display:flex;"><span>mysql&gt; update customers set first_name<span style="color:#ffb8d1">=</span><span style="color:#1bc5e0">&#34;Sally Marie&#34;</span> where id<span style="color:#ffb8d1">=</span>1001;
</span></span></code></pre></div><hr>
<p><code>kubectl run</code>: This command is used to create and run a deployment in a Kubernetes cluster.</p>
<p><code>-n</code> debezium-example: This option specifies the namespace in which the deployment should be created.</p>
<p><code>-it</code>: This option specifies that an interactive terminal should be attached to the container.</p>
<p><code>--rm</code>: This option specifies that the container should be automatically removed when it is stopped.</p>
<p><code>--image=mysql:8.0</code>: This option specifies the Docker image that should be used for the container. In this case, it is using the MySQL 8.0 image.</p>
<p><code>--restart=Never</code>: This option specifies that the container should not be restarted if it exits.</p>
<p><code>--env MYSQL_ROOT_PASSWORD=debezium</code>: This option sets an environment variable for the container, in this case setting the root password for the MySQL instance.</p>
<p><code>mysqlterm</code>: name of the mysql terminal pod created to interact with mysql deployment. This pod is temporary and will be deleted if you exit the terminal</p>
<p><code>mysql -hmysql -P3306 -uroot -pdebezium</code>: These are arguments being passed to the mysql command, which is being run inside the container. It specifies the hostname (-h), port (-P), username (-u), and password (-p) to use when connecting to the MySQL instance.</p>
<hr>
<p>Switch back to previous shell to view the kafka interactive output in json format. View the sample output <a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/sample-mysql-json.json">here</a></p>
<p>If you want to run another <code>kcat</code> command to interact with the kafka broker, use <a href="https://www.middlewareinventory.com/blog/kubectl-exec-examples/">kubectl exec</a> as long as your <code>watcher</code> pod spinned up earlier is still running</p>
<p><code>kubectl exec (POD | TYPE/NAME) [-c CONTAINER] [flags] –- COMMAND [args...] [options]</code></p>
<p>For example, below command will show metadata of the kafka cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl get pod <span style="color:#b0bec5"># check if watcher is still running</span>
</span></span><span style="display:flex;"><span>  NAME                                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>  debezium-cluster-entity-operator-5cc76b7dfb-njt62   3/3     Running   <span style="color:#c5a3ff">0</span>          
</span></span><span style="display:flex;"><span>  debezium-cluster-kafka-0                            1/1     Running   <span style="color:#c5a3ff">0</span>         
</span></span><span style="display:flex;"><span>  debezium-cluster-zookeeper-0                        1/1     Running   <span style="color:#c5a3ff">0</span>          
</span></span><span style="display:flex;"><span>  debezium-connect-cluster-connect-8fd6fd988-7fgsg    1/1     Running   <span style="color:#c5a3ff">0</span>          
</span></span><span style="display:flex;"><span>  mysql-6fc7c66c64-qzbdm                              1/1     Running   <span style="color:#c5a3ff">0</span>          
</span></span><span style="display:flex;"><span>  mysqlterm                                           1/1     Running   <span style="color:#c5a3ff">0</span>          
</span></span><span style="display:flex;"><span>  watcher                                             1/1     Running   <span style="color:#c5a3ff">0</span>          
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $kubectl exec watcher -- kcat -b debezium-cluster-kafka-bootstrap:9092 -C -L
</span></span><span style="display:flex;"><span>  Metadata <span style="color:#c2ffdf">for</span> all topics <span style="color:#ffb8d1">(</span>from broker -1: debezium-cluster-kafka-bootstrap:9092/bootstrap<span style="color:#ffb8d1">)</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c5a3ff">1</span> brokers:
</span></span><span style="display:flex;"><span>    broker <span style="color:#c5a3ff">0</span> at debezium-cluster-kafka-0.debezium-cluster-kafka-brokers.debezium-example.svc:9092 <span style="color:#ffb8d1">(</span>controller<span style="color:#ffb8d1">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c5a3ff">14</span> topics:
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><p>You can also inspect kafka topics with below command. View all the topics that were created for this kafka cluster <a href="https://github.com/anhhchu/debezium-aks/blob/main/debezium-example/kafka-topics.txt">here</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#433e56;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  $kubectl get kt &gt; kafka-topics.txt
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://strimzi.io/blog/2021/03/29/connector-build/">https://strimzi.io/blog/2021/03/29/connector-build/</a></li>
<li><a href="https://strimzi.io/docs/operators/latest/configuring.html#type-Build-reference">https://strimzi.io/docs/operators/latest/configuring.html#type-Build-reference</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">https://kubernetes.io/docs/reference/kubectl/cheatsheet/</a></li>
<li><a href="https://www.middlewareinventory.com/blog/kubectl-exec-examples/">https://www.middlewareinventory.com/blog/kubectl-exec-examples/</a></li>
</ul>

        </div>
      </div>
    </div>
  </div>
</section>


  </div>
  <section class="footer" id="contact">
	<div class="footer__background_shape">
		<svg viewBox="0 0 1920 79">
			<path d="M0 0h1920v79L0 0z" data-name="Path 1450" />
		</svg>
	</div>
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div class="footer__cta">
					<div class="shape-1">
						<svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029">
							<path data-name="Path 1449"
								d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z"
								transform="translate(217.489 188.626)" />
						</svg>
					</div>
					<div class="shape-2">
						<svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029">
							<path data-name="Path 1449"
								d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z"
								transform="translate(217.489 188.626)" />
						</svg>
					</div>
					<div class="text-light footer__cta_content">
						<span>Contact me</span>
						<h2 class="mb-0">Let’s Work Together</h2>
					</div>
					<div class="footer__cta_action">
						<a class="btn btn-light btn-zoom" href="https://anhcodes.dev/contact">Get in
							touch</a>
					</div>
				</div>
			</div>
		</div>
		
			
			
		<div class="row footer__footer">
			<div class="col-lg-6">
				<div class="footer__footer_copy text-light">
					<p>©2023 - Made with ☕, Hugo, and Firebase by <a class="text-light" href="https://anhcodes.dev/" target="_blank">Anh Chu</a></p>
				</div>
			</div>
			<div class="col-lg-6">
				<div class="footer__footer_social">
					<ul class="unstyle-list">
						
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://www.instagram.com/jasminmay12/"><i
									class="fa fa-instagram"></i></a>
						</li>
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://www.linkedin.com/in/anhhchu/"><i
									class="fa fa-linkedin-square"></i></a>
						</li>
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://github.com/anhhchu"><i
									class="fa fa-github-square"></i></a>
						</li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>
</section>

<script src="https://anhcodes.dev/plugins/jQuery/jquery.min.js"></script>
<script src="https://anhcodes.dev/plugins/bootstrap/bootstrap.min.js"></script>
<script src="https://anhcodes.dev/plugins/slick/slick.min.js"></script>
<script src="https://anhcodes.dev/plugins/waypoint/jquery.waypoints.min.js"></script>
<script src="https://anhcodes.dev/plugins/magnafic-popup/jquery.magnific-popup.min.js"></script>
<script src="https://anhcodes.dev/plugins/tweenmax/TweenMax.min.js"></script>
<script src="https://anhcodes.dev/plugins/imagesloaded/imagesloaded.min.js"></script>
<script src="https://anhcodes.dev/plugins/masonry/masonry.min.js"></script>


<script src="https://anhcodes.dev/js/script.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.37.1"></script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch.umd.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css" integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin="anonymous">  

</body>

</html>